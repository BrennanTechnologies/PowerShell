'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[64],{1477:function(t,F,a){a.r(F);var c=a(105),b=a(186),e=a(4);t=a(0);var f=a(15),d=a(85);class h{constructor(G,D,E,M,L,N){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=G;this.WebAffinitizedUrl=D;this.PolicyCookie=E;this.PolicyCookieTTL=M;this.WasServiceDown=L;this.AffinitizedUrl=N}}Object(t.a)(h,
"SafeLinksData",null,[]);class m{constructor(G,D){this.BBc=G;this.stopwatch=D}}Object(t.a)(m,"SafeLinksGetUrlReputationRequestData",null,[]);var l=a(39),v=a(40);class r{constructor(G,D,E,M){this.mb=G;this.ph=D;this.jxg=E;r.rh=M}LBa(G,D,E){try{var M=null;r.rh&&(M=r.rh.Gc("WebServiceCall","SafeLinksGetUrlReputation"));const L=new m(D,M);M={};M.AffinitizedUrl=G;M.TargetUrl=D;M.PolicyCookie=E;const N=l.c(M);this.ph.Im(this.jxg,2,N,null,!1,2,Object(d.a)(this,this.eUi,"onGetUrlReputationSuccessCallback"),
Object(d.a)(this,this.dUi,"onGetUrlReputationFailureCallback"),L,void 0,void 0,3E3,3E3,"36");return!0}catch(L){f.ULS.sendTraceTag(588788033,378,10,L.message)}return!1}eUi(G){let D="OnGetUrlReputationSuccessCallback: ",E=10;const M=G.data.state;try{const L=l.b(G.data.de).reputationResults[0],N=L.navigateUrl.length,Y=M.BBc.length,U=L.navigateUrl===M.BBc;L.navigateUrl&&0<L.navigateUrl.length&&(M.BBc=L.navigateUrl);D+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
G.data.httpStatus,L.verdict,Y.toString(),N.toString(),U.toString());E=50}catch(L){D+=String.format("Exception {0}",L.message)}this.z$e(M,D,E)}dUi(G){let D="OnGetUrlReputationFailureCallback: ";const E=G.data.state;try{D+=String.format("HttpStatus {0}",G.data.httpStatus)}catch(M){D+=String.format("Exception {0}",M.message)}this.z$e(E,D,10)}z$e(G,D,E){G.stopwatch&&(G.stopwatch.stop(),G.stopwatch=null);f.ULS.sendTraceTag(588788034,378,E,D);v.a.gf(G.BBc,void 0,"noopener,noreferrer","SafeLinksNav")}}r.rh=
null;Object(t.a)(r,"SafeLinksNavigationHelper",null,[]);var A;(function(G){G[G.enabledByPolicy=0]="enabledByPolicy";G[G.disabledByPolicy=1]="disabledByPolicy";G[G.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";G[G.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(A||(A={}));Object(t.b)("SafeLinksNavigationState",A);var x=a(99),n=a(138),u=a(798),z=a(256),w=a(242),C=a(699),y=a(27),B=a(174),H=a(193);class I{constructor(G,D,E,M=!1,L=null,N=null){this.QDa=this.PDa=0;this.OAb=
this.TTb=!1;this.Tqa=null;this.CWa=!0;this.vXb=null;f.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.mb=G;this.ph=D;this.opa=E;I.rh=N;this.tGg=M?this.mb.Wa("SafeLinksHandlerWebServiceBase"):this.mb.Wa("WebServiceBase");this.aGg=this.mb.Wa("SafeLinksHashedUserId");this.G6j=this.mb.Wa("SafeLinksWorkloadIdHeaderValue");this.qVb=this.mb.vd("SafeLinksMaxGetPolicyBootRetries",2);this.rVb=this.mb.vd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.xUb=this.isSafeLinksEnabledForUser();
this.wUb=this.sti();f.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.xUb,this.wUb);if(this.xUb&&this.wUb){D=(G=this.a4a())?G.IsSafeLinksEnabled.toLowerCase():"";E=this.Vrd();f.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",D,E);var Y=!G||"unknown"===D||G.WasServiceDown||E,U=n.a.Pr();U&&(U.set("shouldGetSafeLinksDataFromServer",Y.toString()),U.set("isSafeLinksEnabledCacheValue",D.toString()));
L?(this.CWa=!1,L.execute(P=>{P.isFeatureEnabled("MsoUrlreputation",!0).then(aa=>{this.CWa=aa;U.set("isUserLicensedForSafeLinks",this.CWa.toString());x.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",U);this.CWa&&Y&&this.ddc(!0);return null})})):(x.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",U),Y&&this.ddc(!0))}}get appName(){return this.opa}get qFc(){return this.tGg}get userId(){return this.aGg}get P_h(){const G=this.qFc?this.qFc+"/":"",D=new z.QueryStringBuilder("SafeLinksHandler.ashx");
D.$i("app",this.appName);this.mb.pa("SafeLinksUseDebugHeader")&&D.$i("action","debug");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&D.$i("s2satpop","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.$i("s2se03","1");return String.format("{0}{1}&{2}",G,D.toString(),e.AFrameworkApplication.ti)}get M5h(){const G=this.qFc?this.qFc+"/":"",D=new z.QueryStringBuilder("SafeLinksHandler.ashx");D.$i("app",this.appName);
this.mb.pa("SafeLinksUseDebugHeader")&&D.$i("action","debug");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&D.$i("s2satpop","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&D.$i("s2saat","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.$i("s2se03","1");D.$i("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",G,D.toString(),e.AFrameworkApplication.ti)}get gKi(){I.sSc||
(I.sSc=new r(this.mb,this.ph,this.M5h,I.rh));return I.sSc}LBa(G){if(!G)return f.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var D=this.Jpi(G);f.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",D,this.xUb,this.wUb,this.CWa);if(!(D&&this.xUb&&this.wUb&&this.CWa))return!1;D=0;const E=({state:D}=this.ZGj()).returnValue;f.ULS.sendTraceTag(595079385,
378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",A[D]);const M=n.a.Pr();M&&M.set("SafeLinksNavigationState",A[D]);x.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",M);if(!E)return 2!==D&&3!==D||x.Health.instance.recordKpiFailure("SafeLinksNavigations",A[D],!1,!0,null),!1;f.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.fHj())return this.Vrd()?!1:this.gKi.LBa(this.hOh(),G,this.S5e());if(!this.Vrd())return this.Vgg(G),!0;
this.Tqa=G;f.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.OAb=!1;this.ddc();return!0}Jpi(G){G=G.toLowerCase();const D=this.mb.hw("SafeLinksUnsupportedProtocols");if(D)for(let E=0;E<D.length;E++)if(G.startsWith(D[E]))return!1;return!0}ddc(G=!1){var D=n.a.Pr();D&&D.set("isOnBootRequest",G.toString());x.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",D);x.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",
0,"jpittsdirects",D);D=this.k5c("SafeLinksGetPolicy");this.ph.Im(this.P_h,1,null,null,!0,2,Object(d.a)(this,this.k2h,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(d.a)(this,this.j2h,"getSafeLinksDataFromServer_OnFailureCallback"),D,void 0,void 0,void 0,void 0,"23");this.OAb=G;this.TTb=!0;G?this.PDa++:this.QDa++}k2h(G){let D=w.a.dLi,E="";try{this.TTb=this.OAb=!1;var M=G.data.state;const da=({stopwatch:M}=this.KAc(M)).returnValue,qa=Object.assign(new H.a,{durationMs:da});x.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",
qa);f.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",G.data.httpStatus,G.data.de.length,da);if(G.data.httpStatus!==w.a.EO)E="Unexpected httpStatus: "+G.data.httpStatus.toString();else{M=null;try{M=l.b(G.data.de)}catch(O){E="Exception:"+O.toString()+" deserializing response";return}if(M){var L=M.IsSafeLinksEnabled;if(void 0===L||null===L||0>=L.length)E="Invalid isSafeLinksEnabledString";else{f.ULS.sendTraceTag(594830613,
378,50,"Retrieved isSafeLinksEnabledString {0}",L);var N=I.IFd(L);if(void 0===M.WebAffinitizedUrl||null===M.WebAffinitizedUrl||0>=M.WebAffinitizedUrl.length)E="Invalid WebAffinitizedUrl";else if(void 0===M.PolicyCookie||null===M.PolicyCookie||0>=M.PolicyCookie.length)E="Invalid PolicyCookie";else if(void 0===M.PolicyCookieTTL||null===M.PolicyCookieTTL)E="Invalid PolicyCookieTTL";else{var Y=M.WebAffinitizedUrl,U=M.PolicyCookie,P=M.AffinitizedUrl,aa=new Date;aa.setMinutes(aa.getMinutes()+(5<M.PolicyCookieTTL?
M.PolicyCookieTTL-5:0));var X=aa.getTime(),Z=new h(L,Y,U,X,!1,P);this.N3f(Z);D=G.data.httpStatus;this.Tqa&&(N?(this.Vgg(this.Tqa),this.QDa=this.PDa=0):(f.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),x.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),v.a.AU(this.Tqa)),this.Tqa=null)}}}else E="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(da){E="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+
da.toString()}finally{D!==w.a.EO&&this.y$e(D,E)}}j2h(G){this.TTb=!1;let D=500,E="";try{let M=G.data.state;const L=({stopwatch:M}=this.KAc(M)).returnValue,N=Object.assign(new H.a,{durationMs:L});D=G.data.httpStatus;x.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+D.toString(),!1,!0,N);E="Request Failed, Status="+C.a[G.data.status]+" Duration: "+L}catch(M){E="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+M.toString()}finally{this.y$e(D,E)}}y$e(G,D=""){try{if(f.ULS.sendTraceTag(594830612,
378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",G,D),this.PDa<this.qVb&&this.QDa<this.rVb)this.ddc(this.OAb);else{this.OAb=!1;f.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.PDa,this.QDa,G,D);D=null;const E=n.a.Pr();E&&(E.set("HttpStatus",G.toString()),D=Object.assign(new H.a,{extendedProperties:E}));x.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",
!1,!0,D);const M=new h("false","","",0,!0,"");this.N3f(M);this.Tqa&&(f.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),x.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),v.a.AU(this.Tqa),this.Tqa=null)}}catch(E){f.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",E.toString())}}Vgg(G){const D=this.S5e(),E=this.y6h(),M={};M.Url=G;M.SafeLinksCookie=
D;M.CorrelationId=B.a.create().toString();M.WorkloadId=this.G6j;M.UserAgentInfo=y.a.psa+"|"+this.appName;f.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",M.CorrelationId);v.a.bsc(v.a.ZW(4),E,M)}isSafeLinksEnabledForUser(){const G=this.mb.Wa("IsSafeLinksEnabledForUser");return G?I.IFd(G):!1}sti(){const G=this.mb.hw("SafeLinksDisabledBrowsers");if(y.a.WA){if(this.mb.Ep("SafeLinksForTeamsIsEnabled")&&this.mb.pa("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(G,
"Electron"))return!1}else if(Array.contains(G,y.a.psa))return!1;return"officecomhwa"===(this.mb.Wa(e.AFrameworkApplication.C7)||"").toLowerCase()?!1:!0}fHj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&y.a.xba?!0:y.a.WA}ZGj(){let G;G=0;const D=this.a4a(),E=D?D.IsSafeLinksEnabled:"";if(""!==E)return D.WasServiceDown?(f.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),
{returnValue:!1,state:2}):"false"===E.toLowerCase()?(f.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:I.IFd(E),state:G};if(this.TTb)return G=3,f.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:G};if(this.PDa>=this.qVb||this.QDa>=this.rVb)return G=2,f.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.PDa,this.qVb,this.QDa,
this.rVb),{returnValue:!1,state:G};f.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.qVb+this.rVb-(this.PDa+this.QDa));return{returnValue:!0,state:G}}S5e(){const G=this.a4a();return G?G.PolicyCookie:""}y6h(){const G=this.a4a();return G?G.WebAffinitizedUrl:""}hOh(){const G=this.a4a();return G?G.AffinitizedUrl:""}sUh(){const G=new Date;try{const D=this.a4a();
G.setTime(D?D.PolicyCookieTTL:0)}catch(D){f.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",D)}return G}Vrd(){const G=this.sUh();return!!G&&G.getTime()<Date.now()}a4a(){if(!this.vXb){const G=u.a.instance.getItem(this.userId);if(!G||""===G)return null;this.vXb=JSON.parse(G)}return this.vXb}N3f(G){if(void 0===G||null===G)throw Error.argumentNull("safeLinksData");if(void 0===G.IsSafeLinksEnabled||null===G.IsSafeLinksEnabled||0>=G.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");
this.vXb=G;G.WasServiceDown||this.Q6j(G)}Q6j(G){G=JSON.stringify(G);u.a.instance.setItem(this.userId,G)}k5c(G){return void 0!==I.rh&&null!==I.rh?I.rh.Gc("WebServiceCall",G):null}KAc(G){if(void 0!==G&&null!==G){const D=G.Bc;G.stop();return{returnValue:D,stopwatch:null}}return{returnValue:null,stopwatch:G}}static IFd(G){return"false"!==G.toLowerCase()?!0:!1}}I.rh=null;I.sSc=null;Object(t.a)(I,"SafeLinksManager",null,[706]);const R=G=>{switch(G){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";
default:return"Unknown"}},S=G=>{switch(G){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(()=>{Object(b.b)(c.l,{Vba:"singleton"})(()=>new I(e.AFrameworkApplication.fa,e.AFrameworkApplication.Bd,String.format("{0}-{1}",R(e.AFrameworkApplication.ra.Qa.Oj),S(e.AFrameworkApplication.ra.Qa.pca))))})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.safelinks.js.map/062fae4c71cffa07b2e16e40b875faf1/EwaDSEsNext.safelinks.js.map